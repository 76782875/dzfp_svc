<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rjxx.taxeasy.dao.CszbMapper">

	<select id="findOneByParams" parameterType="cszb" resultType="cszb">
		select * from t_cszb where yxbz = '1' and gsdm = #{gsdm}
		<if test="xfid != null and xfid != ''">
			and xfid = #{xfid}
		</if>
		<if test="kpdid != null and kpdid != ''">
			and kpdid = #{kpdid}
		</if>
		limit 1
	</select>
    <select id="findsfzlkpByParams" parameterType="cszb" resultType="cszb">
		select * from t_cszb where yxbz = '1' and gsdm = #{gsdm} and csid=#{csid} 
		<if test="xfid != null and xfid != ''">
			and xfid = #{xfid}
		</if>
		<if test="kpdid != null and kpdid != ''">
			and kpdid = #{kpdid}
		</if>
		limit 1
	</select>
	<select id="findAllByParams" parameterType="map" resultType="cszb">
		select * from t_cszb a,t_csb b where a.csid = b.id and a.yxbz='1' and b.yxbz='1' and gsdm = #{gsdm}
		<if test="xfid != null and xfid != ''">
			and a.xfid = #{xfid}
		</if>
		<if test="kpdid != null and kpdid != ''">
			and a.kpdid = #{kpdid}
		</if>
		<if test="csm != null and csm != ''">
			and b.csm = #{csm}
		</if>
		<if test="csid != null and csid != ''">
			and a.csid = #{csid}
		</if>
	</select>
	<select id="findByPage" parameterType="pagination" resultType="csbVo">
		select a.* from t_cszb a,t_csb b where a.csid=b.id and a.yxbz = '1'
		and b.yxbz = '1' and b.cslx = '2'

		<if test="params.csid != null and params.csid != ''">
			and a.csid = #{params.csid}
		</if>
		<if test="params.csjb != null and params.csjb != ''">
			and b.csjb = #{params.csjb}
		</if>
		<if test="params.gsdm != null and params.gsdm != ''">
			and gsdm = #{params.gsdm}
		</if>
		<if test="params.orderBy != null and params.orderBy != ''">
			order by ${params.orderBy} desc
		</if>
	</select>


	<select id="findAllByGsdmAndCsm" parameterType="map" resultType="csbVo">
		SELECT
		t.gsdm,
		t.xfid,
		t3.xfmc,
		t.kpdid,
		t4.kpdmc,
		max(t.csz) csz
		FROM
		(
		SELECT
		c.gsdm,
		xf.id xfid,
		skp.id kpdid,
		NULL csz
		FROM
		t_gsxx c
		LEFT JOIN (
		SELECT
		b.gsdm,
		b.id
		FROM
		t_xf b
		WHERE
		b.yxbz = '1'
		GROUP BY
		b.gsdm,
		b.id WITH ROLLUP
		) xf ON c.gsdm = xf.gsdm
		LEFT JOIN (
		SELECT
		a.gsdm,
		a.xfid,
		a.id
		FROM
		t_skp a
		WHERE
		a.yxbz = '1'
		GROUP BY
		a.gsdm,
		a.xfid,
		a.id WITH ROLLUP
		) skp ON c.gsdm = skp.gsdm
		AND xf.id = skp.xfid
		WHERE
		c.gsdm = #{gsdm}
		UNION ALL
		SELECT
		e.gsdm,
		e.xfid,
		e.kpdid,
		e.csz
		FROM
		t_csb d
		JOIN t_cszb e ON d.id = e.csid
		WHERE
		d.csm = #{csm}
		AND e.gsdm = #{gsdm}
		AND e.yxbz = '1'
		AND d.yxbz = '1'
		) t
		LEFT JOIN t_xf t3 ON t.xfid = t3.id
		LEFT JOIN t_skp t4 ON t.kpdid = t4.id
		GROUP BY
		t.gsdm,
		t.xfid,
		t3.xfmc,
		t.kpdid,
		t4.kpdmc
		ORDER BY
		1,
		2,
		4
	</select>


	<select id="findKpfsBySkpid" parameterType="map" resultType="kpfsVo">
		select a.gsdm,a.gsmc,a.xfid,a.xfsh,a.xfmc,a.kpdid,a.kpddm,a.kpdmc,a.skph,a.kpfs,a.sbcs,a.csz,a.jkfs,a.skurl,a.kpzdbs
		from v_kpfs a where 1=1
		<if test="gsdm != null and gsdm != ''">
			and a.gsdm = #{gsdm}
		</if>
		<if test="xfid != null and xfid != ''">
			and a.xfid = #{xfid}
		</if>
		<if test="kpdid != null and kpdid != ''">
			and a.kpdid = #{kpdid}
		</if>
		limit 1
	</select>

	<select id="findAllKpfs" parameterType="map" resultType="kpfsVo">
		select a.gsdm,a.gsmc,a.xfid,a.xfsh,a.xfmc,a.kpdid,a.kpddm,a.kpdmc,a.skph,a.kpfs,a.sbcs,a.csz,a.jkfs,a.skurl,a.kpzdbs
		from v_kpfs a where 1=1 and (a.kpzdbs is not null and kpzdbs !='')
		<if test="gsdm != null and gsdm != ''">
			and a.gsdm = #{gsdm}
		</if>
		<if test="xfid != null and xfid != ''">
			and a.xfid = #{xfid}
		</if>
		<if test="kpdid != null and kpdid != ''">
			and a.kpdid = #{kpdid}
		</if>
		<if test="csz != null and csz != ''">
			and a.csz = #{csz}
		</if>
		<if test="skurl2 != null and skurl2 != ''">
			and a.skurl is not NULL
		</if>
		GROUP
	</select>
</mapper>

